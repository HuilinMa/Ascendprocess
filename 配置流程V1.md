# root/autodl-tmp，在此文件夹下面
# 一、将pip缓存路径和HF下载路径写进「当前用户」的 ~/.bashrc，每次登录自动生效：
## 1. 进入数据盘
```bash
    cd /root/autodl-tmp
```

## 2. 建立缓存目录
```bash
mkdir -p pip-cache huggingface
```

## 3. 追加两行到 ~/.bashrc
```bash
echo 'export PIP_CACHE_DIR=/root/autodl-tmp/pip-cache'   >> ~/.bashrc
echo 'export HF_HOME=/root/autodl-tmp/autodl-fs/huggingface'       >> ~/.bashrc
```
## 4. 让当前 shell 立即生效
```bash
source ~/.bashrc
```
## 验证上述操作是否生效：Bash命令行：
```bash
python - <<'PY'
import os, subprocess, pathlib
print("HF_HOME        =", os.getenv("HF_HOME"))
print("PIP_CACHE_DIR  =", os.getenv("PIP_CACHE_DIR"))

r = subprocess.run(["pip", "cache", "dir"], capture_output=True, text=True)## 再看 pip 缓存
print("pip cache dir  =", r.stdout.strip())
PY
```
## 预期输出：
```bash
HF_HOME        = /root/autodl-tmp/autodl-fs/huggingface
PIP_CACHE_DIR  = /root/autodl-tmp/pip-cache
pip cache dir  = /root/autodl-tmp/pip-cache
```
# 二、设置conda环境-把conda自带的pkg缓存、envs目录也改到数据盘：
## 1.建立目录：
```bash
mkdir -p conda_envs conda_pkg
```
## 2.让 conda 把「缓存」和「环境」默认指向数据盘，bash命令：（写入 .condarc，一次配置永久生效）
```bash
cat > ~/.condarc <<'EOF'
envs_dirs:
  - /root/autodl-tmp/conda_envs
pkgs_dirs:
  - /root/autodl-tmp/conda_pkg
EOF
```

## 3.创建新的虚拟环境，rag
conda create -n rag python=3.10 -y
## 4.激活环境，容易出现提示：当前 shell 还没被 conda 初始化，conda activate 所需的函数没加载。在 AutoDL 的容器里（默认 bash），按下面两步即可。

```bash
    conda init bash  # 初始化 bash
    source ~/.bashrc  # 重新加载 shell 配置
```

## 5.运行
```bash
    conda activate rag
```

# 三、设置镜像源为hf-mirror
## Hugging Face模型/数据集下载走 hf-mirror，永久生效（以后每次登录自动加载）
```bash
echo 'export HF_ENDPOINT=https://hf-mirror.com' >> ~/.bashrc
source ~/.bashrc
```
## 验证有效性：
```bash
python -c "import os; print('HF_ENDPOINT =', os.getenv('HF_ENDPOINT'))"
```
## 预期输出：
```bash
HF_ENDPOINT = https://hf-mirror.com
```

# 四、下载postgresql数据库

## 1. apt 换清华源（查看当前源： cat /etc/apt/sources.list）
```bash
sudo cp /etc/apt/sources.list /etc/apt/sources.list.bak
sudo sed -i 's@http://.*.ubuntu.com@https://mirrors.tuna.tsinghua.edu.cn@g' /etc/apt/sources.list
```
## 2.安装 PostgreSQL
## 更新系统包
```bash
sudo apt update && sudo apt upgrade -y
```

## 安装必要的依赖
```bash
sudo apt install -y wget curl gnupg2 software-properties-common
```
## 添加 PostgreSQL 官方仓库
```bash
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
```
## 导入 GPG 密钥
```bash
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
```
## 更新包列表
```bash
sudo apt update
```
## 安装 PostgreSQL (这里安装15版本，你也可以选择其他版本)
```bash
sudo apt install -y postgresql-15 postgresql-client-15 postgresql-server-dev-15
```
## 检查安装是否成功
```bash
dpkg -l | grep postgresql
```
## 查看安装在哪个盘
#程序文件
```bash
df -h /usr/lib/postgresql/15
```
#数据文件
```bash
df -h /var/lib/postgresql/15/main
```
## 查看已安装的版本号以及运行状态。
```bash
pg_lsclusters
```
## 启动数据库，如果版本为15：
```bash
sudo pg_ctlcluster 15 main start
```
## 验证连接。有时候sudo失效，apt install -y sudo
```bash
    sudo -u postgres psql -c "SELECT version();"
```

# 五、安装pgvector(版本0.6.0)
## 安装构建工具
    sudo apt install make gcc
## 克隆 pgvector 源码
    git config --global http.version HTTP/1.1
    git clone https://github.com/pgvector/pgvector.git
    cd pgvector

## 检出最新版本
    git checkout v0.6.0
## 构建并安装
    make
    sudo make install
    cd ..
## 在PostgreSQL中启用pgvector扩展
    sudo -u postgres psql
## 然后运行：
    CREATE EXTENSION vector;
    SELECT extversion FROM pg_extension WHERE extname = 'vector';
## 验证功能，验证向量功能是否正常
-- 创建一个测试表
    CREATE TABLE items (id serial PRIMARY KEY, embedding vector(3));

-- 插入一条 3 维向量
    INSERT INTO items (embedding) VALUES ('[1,2,3]');

-- 查询最邻近向量（L2 距离）
    SELECT * FROM items ORDER BY embedding <-> '[1,1,1]' LIMIT 1;

## 退出
    \q

# 六、下载vLLM
## 1.安装vllm和vllm ascend
    git clone --depth 1 --branch v0.7.3 https://github.com/vllm-project/vllm
    cd vllm
    ## 修复，改shebang: sed -i '1s|.*|#!/root/autodl-tmp/conda_envs/rag/bin/python3.10|' /root/autodl-tmp/conda_envs/rag/bin/pip
    VLLM_TARGET_DEVICE=empty pip install . --extra-index https://download.pytorch.org/whl/cpu/

    git clone  --depth 1 --branch v0.7.3rc1 https://github.com/vllm-project/vllm-ascend.git
    cd vllm-ascend
    pip install -e . --extra-index https://download.pytorch.org/whl/cpu/

## 2.手动安装torch-npu
    mkdir pta
    cd pta
    wget https://pytorch-package.obs.cn-north-4.myhuaweicloud.com/pta/Daily/v2.5.1/20250320.3/pytorch_v2.5.1_py310.tar.gz
    tar -xvf pytorch_v2.5.1_py310.tar.gz
    pip install ./torch_npu-2.5.1.dev20250320-cp310-cp310-manylinux_2_17_aarch64.manylinux2014_aarch64.whl
    pip install torchvision==0.20.1
# 七、下载模型
## 1.准备
    mkdir -p /root/autodl-fs
    cd /root/autodl-fs
    pip install -U huggingface-hub
## 2.下载嵌入模型（bge-large-zh）
    #hf download --local-dir bge-large-zh BAAI/bge-large-zh
镜像加速: 
    pip install modelscope==1.22.0
    modelscope download --model BAAI/bge-large-zh --local_dir bge-large-zh
    
## 3.部署生成式大模型
    modelscope download --model Qwen/Qwen-7B-Chat --local_dir qwen-7b-chat
    modelscope download --model Qwen/Qwen2.5-VL-7B-Instruct --local_dir Qwen2.5-VL-7B-Instruct
    modelscope download --model deepseek-ai/deepseek-llm-7b-chat --local_dir deepseek-7b-chat
    modelscope download --model intfloat/multilingual-e5-large-instruct --local_dir multilingual-large-instruct
    modelscope download --model iic/gme-Qwen2-VL-7B-Instruct --local_dir gme-Qwen2-VL-7B-embed

# 突发：发现无华为昇腾专区挂载！全部暂时移到数据盘。
## 1. 创建目标目录
    mkdir -p /root/autodl-tmp/autodl-fs

## 2. 整体搬过去
    mv /root/autodl-fs/* /root/autodl-tmp/autodl-fs/

## 3. 确认
    du -h -d 0 /root/autodl-tmp/autodl-fs
### ModelScope推理：
    pip install modelscope transformers_stream_generator
    python test_modelscope.py
### 使用vLLM推理
    pip install "transformers>=4.38.0,<4.49.0" --upgrade
    export VLLM_USE_MODELSCOPE=true 
    python test_vLLM.py

升级了transformers版本：
pip install git+https://github.com/huggingface/transformers.git
结果：Name: transformers，Version: 4.57.0.dev0
    






