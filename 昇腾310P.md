## æŸ¥çœ‹æ˜‡è…¾å¥—ä»¶ç‰ˆæœ¬
    cat /usr/local/Ascend/ascend-toolkit/latest/version.cfg | grep runtime_running
runtime_running_version=[8.2.0.0.201:8.2.RC1]
## æŸ¥çœ‹CPUæ¶æ„
    uname -m
aarch
# æŸ¥çœ‹æ“ä½œç³»ç»Ÿ
    cat /etc/os-release
NAME="CleverOS"
VERSION="3.0"
ID="CleverOS"
VERSION_ID="3.0"
PRETTY_NAME="CleverOS 3.0"
ANSI_COLOR="0;31"

# æŸ¥çœ‹ç³»ç»Ÿè¯¦ç»†é…ç½®ï¼šhostnamectl
   Static hostname: (unset)                         
Transient hostname: localhost
         Icon name: computer-server
           Chassis: server ğŸ–³
        Machine ID: b7d2391ee1134c1fa5d4667c4a9c94f7
           Boot ID: 267616023c8c48b0b7a2ee09e4df190b
  Operating System: CleverOS 3.0
            Kernel: Linux 6.6.0-108.0.0.115.aarch64
      Architecture: arm64
   Hardware Vendor: HUAKUN
    Hardware Model: HuaKun AT800 _Model 3000_
  Firmware Version: 6.70
     Firmware Date: Wed 2024-04-03
      Firmware Age: 1y 6month 1w 6d

# æ•°æ®åº“é…ç½®
    sudo groupadd -g 26 postgres
    sudo useradd -u 26 -g 26 -M -s /bin/bash postgres
    id postgres

# å¯åŠ¨æ•°æ®åº“
sudo -u postgres /home/pgdata/bin/pg_ctl -D /home/pgdata/data -l /tmp/pg.log start
## çŠ¶æ€
sudo -u postgres /home/pgdata/bin/pg_ctl -D /home/pgdata/data status
## 
sudo -u postgres /home/pgdata/bin/pg_ctl -D /home/pgdata/data -l /tmp/pg.log stop
# 1. ç›´æ¥è¿åº“éªŒè¯
sudo -u postgres /home/pgdata/bin/psql -h localhost -c 'SHOW server_version;'

# 2. çœ‹ pg_config ç‰ˆæœ¬
/home/pgdata/bin/pg_config --version
## ç„¶åè¿è¡Œï¼š
    ä½¿ç”¨16.3ç‰ˆæœ¬ï¼š
    /home/pgdata/bin/psql -h localhost -U postgres
    CREATE EXTENSION vector;
    SELECT extversion FROM pg_extension WHERE extname = 'vector';
## éªŒè¯åŠŸèƒ½ï¼ŒéªŒè¯å‘é‡åŠŸèƒ½æ˜¯å¦æ­£å¸¸
-- åˆ›å»ºä¸€ä¸ªæµ‹è¯•è¡¨
    CREATE TABLE items (id serial PRIMARY KEY, embedding vector(3));

-- æ’å…¥ä¸€æ¡ 3 ç»´å‘é‡
    INSERT INTO items (embedding) VALUES ('[1,2,3]');

-- æŸ¥è¯¢æœ€é‚»è¿‘å‘é‡ï¼ˆL2 è·ç¦»ï¼‰
    SELECT * FROM items ORDER BY embedding <-> '[1,1,1]' LIMIT 1;

## é€€å‡º
    \q

# å®‰è£…ç®—å­åŒ…
## éªŒè¯æ˜¯å¦å®‰è£…
    grep -i "opp" /var/log/ascend_seclog/*
## å¦ä¸€ç§æ£€éªŒæ–¹å¼
    which msopgen
    echo $ASCEND_OPP_PATH
### å·²ç»åœ¨ls /usr/local/Ascend/ascend-toolkit/8.2.RC1/opp

# ä¸‹é¢éœ€è¦å®‰è£…lmdeploy
## åœ¨çº¿ä¸‹è½½ï¼š
git clone https://github.com/InternLM/lmdeploy.git
cd lmdeploy
git checkout v0.9.2                # æ ‡ç­¾å­˜åœ¨ï¼Œä½†æ—  wheel
tar czvfæ‰“åŒ…
### æ£€éªŒï¼šæ‰äº†å“ªä¸ªåŒ…ï¼Œå•ç‹¬å®‰è£…å“ªä¸ªåŒ…ï¼ˆcmakeï¼‰
## ç¦»çº¿å®‰è£…
    export LMDEPLOY_TARGET_DEVICE=ascend 
    pip install -v --no-build-isolation -e .

## å®‰è£…æ¨¡å‹
    pip install modelscope==1.22.0
    modelscope download --model BAAI/bge-large-zh --local_dir bge-large-zh
    modelscope download --model Qwen/Qwen2.5-VL-7B-Instruct --local_dir Qwen2.5-VL-7B-Instruct

## ä»¥å¯ç¼–è¾‘æ¨¡å¼å®‰è£…lmdeploy
pip install -e .
## æ¨ç†æ¨¡å‹
    export TOKENIZERS_PARALLELISM=false
    export PYTORCH_NPU_ALLOC_CONF=expandable_segments:True
    export ASCEND_LAUNCH_BLOCKING=1
# æ¨ç†
## è®¾ç½®ç¯å¢ƒå˜é‡
source /usr/local/Ascend/ascend-toolkit/set_env.sh
# éªŒè¯ç«¯å£å·æ˜¯å¦è¢«å ç”¨
    sudo netstat -tulnp | grep 8000
## å–æ¶ˆ ASCEND_RT_VISIBLE_DEVICES çš„è®¾ç½®
    unset ASCEND_RT_VISIBLE_DEVICES
# ä½¿ç”¨NNAL/ATBåŠ é€Ÿåº“
echo "source ${HOME}/Ascend/nnal/atb/set_env.sh" >> ~/.bashrc
source ~/.bashrc
# ä»¥ä¾¿ Python èƒ½å¤Ÿæ‰¾åˆ° libpq.so.5
find / -name libpq.so.5 2>/dev/null
echo 'export LD_LIBRARY_PATH=/home/pgdata/lib:$LD_LIBRARY_PATH' >> ~/.bashrc
source ~/.bashrc
## å¼€å¯
lmdeploy serve api_server \
        /home/models/Qwen2.5-7B-Instruct\
        --backend pytorch \
        --device ascend \
        --tp 4 \
        --dtype float16 \
        --server-name 0.0.0.0 \
        --server-port 8000 \
        --log-level ERROR


# æµ‹è¯•
curl -X POST http://localhost:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "/home/models/Qwen2.5-7B-Instruct",
    "messages": [{"role": "user", "content": "hi"}],
    "max_tokens": 32
  }'

  # å¯åŠ¨ç¨‹åº
cd uchat
python chat.py

# å¯åŠ¨å‰ç«¯ç•Œé¢
streamlit run web/entrance.py 