## 查看昇腾套件版本
    cat /usr/local/Ascend/ascend-toolkit/latest/version.cfg | grep runtime_running
runtime_running_version=[8.2.0.0.201:8.2.RC1]
## 查看CPU架构
    uname -m
aarch
# 查看操作系统
    cat /etc/os-release
NAME="CleverOS"
VERSION="3.0"
ID="CleverOS"
VERSION_ID="3.0"
PRETTY_NAME="CleverOS 3.0"
ANSI_COLOR="0;31"

# 查看系统详细配置：hostnamectl
   Static hostname: (unset)                         
Transient hostname: localhost
         Icon name: computer-server
           Chassis: server 🖳
        Machine ID: b7d2391ee1134c1fa5d4667c4a9c94f7
           Boot ID: 267616023c8c48b0b7a2ee09e4df190b
  Operating System: CleverOS 3.0
            Kernel: Linux 6.6.0-108.0.0.115.aarch64
      Architecture: arm64
   Hardware Vendor: HUAKUN
    Hardware Model: HuaKun AT800 _Model 3000_
  Firmware Version: 6.70
     Firmware Date: Wed 2024-04-03
      Firmware Age: 1y 6month 1w 6d

# 数据库配置
    sudo groupadd -g 26 postgres
    sudo useradd -u 26 -g 26 -M -s /bin/bash postgres
    id postgres

# 启动数据库
sudo -u postgres /home/pgdata/bin/pg_ctl -D /home/pgdata/data -l /tmp/pg.log start
## 状态
sudo -u postgres /home/pgdata/bin/pg_ctl -D /home/pgdata/data status
## 
sudo -u postgres /home/pgdata/bin/pg_ctl -D /home/pgdata/data -l /tmp/pg.log stop
# 1. 直接连库验证
sudo -u postgres /home/pgdata/bin/psql -h localhost -c 'SHOW server_version;'

# 2. 看 pg_config 版本
/home/pgdata/bin/pg_config --version
## 然后运行：
    使用16.3版本：
    /home/pgdata/bin/psql -h localhost -U postgres
    CREATE EXTENSION vector;
    SELECT extversion FROM pg_extension WHERE extname = 'vector';
## 验证功能，验证向量功能是否正常
-- 创建一个测试表
    CREATE TABLE items (id serial PRIMARY KEY, embedding vector(3));

-- 插入一条 3 维向量
    INSERT INTO items (embedding) VALUES ('[1,2,3]');

-- 查询最邻近向量（L2 距离）
    SELECT * FROM items ORDER BY embedding <-> '[1,1,1]' LIMIT 1;

## 退出
    \q

# 安装算子包
## 验证是否安装
    grep -i "opp" /var/log/ascend_seclog/*
## 另一种检验方式
    which msopgen
    echo $ASCEND_OPP_PATH
### 已经在ls /usr/local/Ascend/ascend-toolkit/8.2.RC1/opp

# 下面需要安装lmdeploy
## 在线下载：
git clone https://github.com/InternLM/lmdeploy.git
cd lmdeploy
git checkout v0.9.2                # 标签存在，但无 wheel
tar czvf打包
### 检验：掉了哪个包，单独安装哪个包（cmake）
## 离线安装
    export LMDEPLOY_TARGET_DEVICE=ascend 
    pip install -v --no-build-isolation -e .

## 安装模型
    pip install modelscope==1.22.0
    modelscope download --model BAAI/bge-large-zh --local_dir bge-large-zh
    modelscope download --model Qwen/Qwen2.5-VL-7B-Instruct --local_dir Qwen2.5-VL-7B-Instruct

## 以可编辑模式安装lmdeploy
pip install -e .
## 推理模型
    export TOKENIZERS_PARALLELISM=false
    export PYTORCH_NPU_ALLOC_CONF=expandable_segments:True
    export ASCEND_LAUNCH_BLOCKING=1
# 推理
## 设置环境变量
source /usr/local/Ascend/ascend-toolkit/set_env.sh
# 验证端口号是否被占用
    sudo netstat -tulnp | grep 8000
## 取消 ASCEND_RT_VISIBLE_DEVICES 的设置
    unset ASCEND_RT_VISIBLE_DEVICES
# 使用NNAL/ATB加速库
echo "source ${HOME}/Ascend/nnal/atb/set_env.sh" >> ~/.bashrc
source ~/.bashrc
# 以便 Python 能够找到 libpq.so.5
find / -name libpq.so.5 2>/dev/null
echo 'export LD_LIBRARY_PATH=/home/pgdata/lib:$LD_LIBRARY_PATH' >> ~/.bashrc
source ~/.bashrc
## 开启
lmdeploy serve api_server \
        /home/models/Qwen2.5-7B-Instruct\
        --backend pytorch \
        --device ascend \
        --tp 4 \
        --dtype float16 \
        --server-name 0.0.0.0 \
        --server-port 8000 \
        --log-level ERROR


# 测试
curl -X POST http://localhost:8000/v1/chat/completions \
  -H "Content-Type: application/json" \
  -d '{
    "model": "/home/models/Qwen2.5-7B-Instruct",
    "messages": [{"role": "user", "content": "hi"}],
    "max_tokens": 32
  }'

  # 启动程序
cd uchat
python chat.py

# 启动前端界面
streamlit run web/entrance.py 